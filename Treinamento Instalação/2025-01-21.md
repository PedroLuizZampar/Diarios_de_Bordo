# üìå **Di√°rio de Bordo 21/01/2025**
## *Sequ√™ncia na atualiza√ß√£o de vers√£o do sistema ERP e do SisAtak*

### ‚úàÔ∏è Migrate de vers√£o
> O migrate √© apenas para o banco de dados. Em uma atualiza√ß√£o, √© preciso rodar o migrate antes de atualizar o ERP
- Executamos um migrate para quem n√£o conseguiu rodar o migrate ontem.
- üìÅ **Caminho:** ```C:\SISATAK\Vers√£o\[nome da vers√£o]\Tools\MigrateDB```
    - Para rodar o migrate, abrimos o CMD nessa pasta e executamos o comando:
    ``` 
    migrate-cmd [Inst√¢ncia] [Nome do banco] [Login] [Senha] up
    ```

---

### üì• Atualiza√ß√£o de Vers√£o do ERP
- Mesmo processo de atualiza√ß√£o de release:
    - Instalar os zips **API**, **APP**, **CORE** e **PORTAL** na plataforma de vers√µes e extra√≠-los
    - Editamos o arquivo **```web.config```** que est√° dentro da pasta **CORE**
        - No campo ```ServidorDeLicen√ßas``` colocamos o IP da m√°quina que possui o gerenciador de licen√ßas do sistema
    - Paramos os servi√ßos do sistema **(Servi√ßos -> Servi√ßo de Processamentos Atak (8040) -> Parar)**
    - Acessamos o IIS e clicamos com o bot√£o direito sobre a pasta ERPATAKX e depois clicamos em explorar para acessar a pasta raiz do sistema ERP
    
    - Copiamos os arquivos e pastas de dentro das novas pastas para as pastas originais do sistema **(APP -> APP; API -> API; CORE -> CORE; PORTAL -> ERPATAKX (raiz))**
    - Por fim, abrimos o sistema ERP e iniciamos os servi√ßos novamente
    - Para atualizar a exibi√ß√£o da vers√£o na aba do navegador, pressionamos ```CTRL+F5```

---

### üÜïüåê Atualiza√ß√£o de uma API
- Acessar a pasta API baixada do site de vers√µes (versoes.atak.com.br)
- Editar o arquivo web.config no campo ```ServidorDeLicen√ßas``` (Remover o coment√°rio e adicionar o IP da m√°quina com o gerenciador de licen√ßas)
- Acessar a pasta da API **(IIS -> [ selecionar a API ] -> bot√£o direito -> explorar)**
- Colar todos os arquivos e pastas da pasta baixada do site de vers√µes para a pasta da API

---

### üîÑüñ•Ô∏è Restaurando base de testes
- SSMS -> Bot√£o direito na pasta Bancos de Dados -> Restaurar Banco de Dados -> Dispositivo -> 3 pontinhos -> (selecionamos o arquivo de banco) -> Mudamos o nome para SATKTESTE -> Conferimos o nome dos arquivos MDF e LDF (o final precisa ser SATKTESTE)
- Para usar a base de testes, √© preciso criar um **novo site** no IIS
- Rodamos um migrate e atualizamos o banco de testes para a vers√£o 2024.4 para realizarmos o processo de atualiza√ß√£o do sistema novamente

``` SQL
-- Esse comando verifica a vers√£o do banco
select * from tbversao
```
---

### ‚§¥Ô∏èüåê Subindo o site para usar a base de testes
- Extra√≠mos as pastas ```API```, ```APP```, ```CORE``` e ```PORTAL```;
- Tiramos a vers√£o do nome das pastas;
- Renomeamos a pasta portal para **`ERPATAK_TESTE`**;
- Jogamos todas as pastas para a pasta **ERPATAK_TESTE**;
- Na pasta **```CORE```**, √© preciso colocar a string de conex√£o (editando a base para que seja tudo feito na base teste) e editar o arquivo ```web.config``` colocando o IP correto no campo ```ServidorDeLicen√ßas```;
- Criamos uma c√≥pia da pasta **ERPATAK_TESTE** na pasta ```C:\inetpub```
- No IIS, criei um site com a pasta ERPATAK_TESTE e coloquei o nome **ERPATAK_TESTE**. **O SITE PRECISA SER CRIADO EM UMA PORTA DIFERENTE DO SITE DE PRODU√á√ÉO**;
- Convertemos as pastas ```APP```, ```API``` e ```CORE``` para aplicativos;
- Criamos um pool para cada aplicativo (bot√£o direito -> nova pool -> [NOME] -> ok);
- Alteramos os seguintes campos (bot√£o direito -> configura√ß√µes avan√ßadas);
    - Modo de In√≠cio: Always Running
    - Identidade: Local System
    - Intervalo de Tempo Regular (minutos): 480
    
>**AS ALTERA√á√ïES DEVEM SER FEITAS NAS POOLS DO SITE, NA APP, NA API E NA CORE!**

- Ap√≥s isso √© so executar o site.

---

### Rotina de Backups

- Criamos uma c√≥pia da pasta ```BAT de BKP``` na pasta ```C:\MSSQL\BACKUP```
- Essa pasta (```BAT de BKP```) possui 3 arquivos de rotinas de backup
- Configuramos esses arquivos para realizar rotinas de backup no sistema (bot√£o direito -> editar).
- No arquivo alteramos todas as informa√ß√µes na frente dos comandos, o caminho do arquivo e o nome do banco no trecho ```NAME=```.
- Depois disso copiamos de o que foi feito em um arquivo para outro, alterando apenas o nome do arquivo de sa√≠da.

>### *Informa√ß√µes no arquivo:*
>| Comando      |    Defini√ß√£o   |
>|--------------|----------------|
>| **-S**       | Conex√£o SQL    |
>| **-d**       | Base de Dados  |
>| **-P**       | Senha          |
>| **-U**       | Usu√°rio        |
>| **-Q**       | Query          |

 - #### **Automatizando a rotina**

    - Agendador de Tarefas -> Criar Tarefa
    - **Nome:** BKP_[ Turno ]
    - **Marcar a op√ß√£o:** Executar estando o usu√°rio ou n√£o
    - Disparadores -> Novo -> Di√°rio -> [ Informar a hora ] -> repetir a cada 1 dia
    - A√ß√µes -> Novo -> Iniciar um programa -> Selecionar o arquivo que est√° na pasta ```C:\MSSQL\BACKUP```

---

### Backup manual

- Bot√£o direito na base -> Tarefas -> Fazer Backup
- Tipo de backup: Completo
- Caminho: ```C:\MSSQL\BACKUP\[ NOME DO ARQUIVO ].BAK```

---

> Hoje saiu uma nova vers√£o para o SisAtak (ERP Desktop) e atualizamos novamente. Para atualizar, baixamos apenas o SisAtak upgrade e executamos o arquivo, apontando o caminho de instala√ß√£o no caminho **```C:/SISATAK/Vers√£o```**. Quando fazemos dessa forma, o sistema n√£o gera uma nova pasta na pasta ```C:/SISATAK/Vers√£o```, que por ser uma release apenas, n√£o existe a necessidade de uma nova pasta.

---

### üîé Depend√™ncias
- Quando h√° uma atualiza√ß√£o de vers√£o, √© preciso atualizar as depend√™ncias da Tecnospeed.
    - No servidor, isso √© feito executando os arquivos de depend√™ncias.
    - Nas esta√ß√µes, isso √© feito executando o instalador da esta√ß√£o, baixado no site vers√µes.atak.com.br
    - As instala√ß√µes de depend√™ncias s√≥ se fazem necess√°rias se elas est√£o na rotina do cliente.
    - Para verificar a vers√£o do servidor com a esta√ß√£o, no **SisAtak (ERP Desktop)** vamos em **Ferramentas -> Valida√ß√£o de Arquivos Tecnospeed no Servidor**. A vers√£o estar√° OK se na coluna da direita, onde tiver n√∫meros, os valores ficarem na cor verde.

---

# üö® **Importante!**

- ### **JAMAIS DAR UM UPDATE SEM WHERE!**
- ### **ANTES DE QUALQUER ATUALIZA√á√ÉO, REALIZAR UM BACKUP E RESTAURAR EM UMA BASE TESTE PARA VERIFICAR SE EST√Å TUDO OK!**
    - #### Para isso, restauramos o banco de dados por cima da base teste, ou ent√£o deletamos a base teste e fazemos a restaura√ß√£o com o nome SATKTESTE
